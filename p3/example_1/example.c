#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <time.h>
#include <mpi.h>

void printMatrix(int * matrix, int n);
int * multiplyMatrix_ijk(int * matrix_1, int * matrix_2,
    int n, int num_rows);
    int * multiplyMatrix_ikj(int * matrix_1, int * matrix_2,
        int n, int num_rows);
        int * multiplyMatrix_kij(int * matrix_1, int * matrix_2,
            int n, int num_rows);


            int * multiplyMatrix_ijk_with_trans(int * matrix_1, int * matrix_2,
                int n, int num_rows);
                int * multiplyMatrix_ikj_with_trans(int * matrix_1, int * matrix_2,
                    int n, int num_rows);
                    int * multiplyMatrix_kij_with_trans(int * matrix_1, int * matrix_2,
                        int n, int num_rows);

                        void transpose(int * matrix, int n);

                        //to test with the second matrix transposed, set to 1
                        const int DO_TRANSPOSE = 1;
                        int main() {
                          int num_processes;
                            int my_rank;

                              //start MPI
                                MPI_Init(NULL, NULL);

                                  MPI_Comm_size(MPI_COMM_WORLD, &num_processes);

                                    MPI_Comm_rank(MPI_COMM_WORLD, &my_rank);

                                      int * matrix_1;
                                        int * matrix_2;

                                          char form[4];
                                            char flag;
                                              int n; //each matrix is n X n

                                                if (my_rank == 0) {
                                                    printf("running on %d processors\n", num_processes);

                                                        scanf(" %s", form);

                                                            scanf(" %c", &flag);

                                                                scanf(" %d", &n);

                                                                    matrix_1 = malloc(sizeof(int) * n * n);
                                                                        matrix_2 = malloc(sizeof(int) * n * n);

                                                                            //generate random matrices
                                                                                if (flag == 'R') {
                                                                                      srand(time(0));
                                                                                            int row, col;
                                                                                                  //generate the 2 matrices with numbers between 0 and 100
                                                                                                        for (row = 0; row < n; row++) {
                                                                                                                for (col = 0; col < n; col++) {
                                                                                                                          matrix_1[row * n + col] = rand() % 100;
                                                                                                                                    matrix_2[row * n + col] = rand() % 100;
                                                                                                                                            }
                                                                                                                                                  }
                                                                                                                                                      //else take in matrix input
                                                                                                                                                          } else {
                                                                                                                                                                int row, col;
                                                                                                                                                                      //take in the input for matrix one
                                                                                                                                                                            for (row = 0; row < n; row++) {
                                                                                                                                                                                    for (col = 0; col < n; col++) {
                                                                                                                                                                                              scanf(" %d", (matrix_1 + row * n + col));
                                                                                                                                                                                                      }
                                                                                                                                                                                                            }

                                                                                                                                                                                                                  //take in the input for matrix two
                                                                                                                                                                                                                        for (row = 0; row < n; row++) {
                                                                                                                                                                                                                                for (col = 0; col < n; col++) {
                                                                                                                                                                                                                                          scanf(" %d", (matrix_2 + row * n + col));
                                                                                                                                                                                                                                                  }
                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                              }

                                                                                                                                                                                                                                                                MPI_Barrier(MPI_COMM_WORLD);

                                                                                                                                                                                                                                                                  double start_time = MPI_Wtime(), finish_time, elapsed_time;

                                                                                                                                                                                                                                                                    //make sure everyone knows what n is
                                                                                                                                                                                                                                                                      MPI_Bcast(&n, 1, MPI_INT, 0, MPI_COMM_WORLD);

                                                                                                                                                                                                                                                                        char middle_of_form;
                                                                                                                                                                                                                                                                          if (my_rank == 0)
                                                                                                                                                                                                                                                                              middle_of_form = form[1];
                                                                                                                                                                                                                                                                                /*make sure everyone has the inidicator of ijk, ikj, or kij
                                                                                                                                                                                                                                                                                  (j indicates ijk, k indicates ikj, i indicates kij)*/
                                                                                                                                                                                                                                                                                    MPI_Bcast(&middle_of_form, 1, MPI_CHAR, 0, MPI_COMM_WORLD);

                                                                                                                                                                                                                                                                                      int local_n = n / num_processes;

                                                                                                                                                                                                                                                                                        int * matrix_result_part = NULL;

                                                                                                                                                                                                                                                                                          /*if n is not divisible by num_processes then check if this
                                                                                                                                                                                                                                                                                            process needs to take and process one extra row*/
                                                                                                                                                                                                                                                                                              int mod_local_n = (n % num_processes >= my_rank + 1) ?
                                                                                                                                                                                                                                                                                                    (local_n + 1) : local_n;

                                                                                                                                                                                                                                                                                                      //this will contain local_n rows of matrix_1 after the scatter
                                                                                                                                                                                                                                                                                                        int * local_matrix_1 = malloc(sizeof(int) * mod_local_n * n);
                                                                                                                                                                                                                                                                                                          //this will contain the whole second matrix (possibly transposed)
                                                                                                                                                                                                                                                                                                            int * local_matrix_2 = NULL;

                                                                                                                                                                                                                                                                                                              int * displacements = NULL;
                                                                                                                                                                                                                                                                                                                int * send_counts = NULL;
                                                                                                                                                                                                                                                                                                                  int n_times_local_n = n * local_n;
                                                                                                                                                                                                                                                                                                                    //preparation for MPI_Scatterv
                                                                                                                                                                                                                                                                                                                      if (my_rank == 0) {
                                                                                                                                                                                                                                                                                                                          displacements = (int *) malloc(num_processes*sizeof(int));
                                                                                                                                                                                                                                                                                                                              send_counts = (int *) malloc(num_processes*sizeof(int));
                                                                                                                                                                                                                                                                                                                                  int i;
                                                                                                                                                                                                                                                                                                                                      for (i = 0; i < num_processes; ++i) {
                                                                                                                                                                                                                                                                                                                                            if (n % num_processes >= i + 1) {
                                                                                                                                                                                                                                                                                                                                                    //this i'th process gets an extra row of data
                                                                                                                                                                                                                                                                                                                                                            send_counts[i] = n_times_local_n + n;
                                                                                                                                                                                                                                                                                                                                                                  } else {
                                                                                                                                                                                                                                                                                                                                                                          //this i'th process gets normal amount of rows of data
                                                                                                                                                                                                                                                                                                                                                                                  send_counts[i] = n_times_local_n;
                                                                                                                                                                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                                                                                                                                                                              if (i == 0)
                                                                                                                                                                                                                                                                                                                                                                                                      displacements[0] = 0;
                                                                                                                                                                                                                                                                                                                                                                                                            else
                                                                                                                                                                                                                                                                                                                                                                                                                    displacements[i] = displacements[i-1] + send_counts[i-1];
                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                          }

                                                                                                                                                                                                                                                                                                                                                                                                                            /*scatter matrix_1 so that each process gets a certain
                                                                                                                                                                                                                                                                                                                                                                                                                              amount of rows of matrix_1; mod_local_n * n means that this process
                                                                                                                                                                                                                                                                                                                                                                                                                                gets mod_local_n rows of matrix_1*/
                                                                                                                                                                                                                                                                                                                                                                                                                                  MPI_Scatterv(matrix_1, send_counts, displacements, MPI_INT,
                                                                                                                                                                                                                                                                                                                                                                                                                                        local_matrix_1, mod_local_n * n, MPI_INT, 0, MPI_COMM_WORLD);

                                                                                                                                                                                                                                                                                                                                                                                                                                          if (my_rank != 0) {
                                                                                                                                                                                                                                                                                                                                                                                                                                              //prepare to receive the broadcast of matrix_2
                                                                                                                                                                                                                                                                                                                                                                                                                                                  matrix_2 = malloc(sizeof(int) * n * n);
                                                                                                                                                                                                                                                                                                                                                                                                                                                    } else {
                                                                                                                                                                                                                                                                                                                                                                                                                                                        //transpose matrix_2 if the constant is set to 1
                                                                                                                                                                                                                                                                                                                                                                                                                                                            if (DO_TRANSPOSE) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                  transpose(matrix_2, n);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                          //get/broadcast the full matrix_2
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            MPI_Bcast(matrix_2, n * n, MPI_INT, 0, MPI_COMM_WORLD);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                              local_matrix_2 = matrix_2;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if (!DO_TRANSPOSE) { //the second matrix is NOT transposed
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if (middle_of_form == 'j') {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          //multiply the matrices using ijk
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                matrix_result_part = multiplyMatrix_ijk(local_matrix_1,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          local_matrix_2, n, mod_local_n);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              } else if (middle_of_form == 'k') {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    //multiply the matrices using ikj
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          matrix_result_part = multiplyMatrix_ikj(local_matrix_1,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    local_matrix_2, n, mod_local_n);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        } else if (middle_of_form == 'i') {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              //multiply the matrices using kij
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    matrix_result_part = multiplyMatrix_kij(local_matrix_1,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              local_matrix_2, n, mod_local_n);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    } else { //the second matrix is transposed
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if (middle_of_form == 'j') {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              //multiply the matrices using ijk
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    matrix_result_part = multiplyMatrix_ijk_with_trans(local_matrix_1,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              local_matrix_2, n, mod_local_n);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  } else if (middle_of_form == 'k') {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        //multiply the matrices using ikj
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              matrix_result_part = multiplyMatrix_ikj_with_trans(local_matrix_1,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        local_matrix_2, n, mod_local_n);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            } else if (middle_of_form == 'i') {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  //multiply the matrices using kij
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        matrix_result_part = multiplyMatrix_kij_with_trans(local_matrix_1,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  local_matrix_2, n, mod_local_n);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          /*gather all the partial results into the result and
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            put the final result in matrix_1 (each process contains
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              at least local_n rows of the matrix result)*/
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                MPI_Gatherv(matrix_result_part, mod_local_n * n, MPI_INT, matrix_1,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      send_counts, displacements, MPI_INT, 0, MPI_COMM_WORLD);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        //print the results if master
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          if (my_rank == 0) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              finish_time = MPI_Wtime();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  elapsed_time = finish_time - start_time;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      printf("elapsed time = %e seconds\n", elapsed_time);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          if (flag != 'R') {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                printMatrix(matrix_1, n);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        //release all allocated memory:

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          if (my_rank == 0) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              //these are only malloced at my_rank = 0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  free(matrix_1);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      free(displacements);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          free(send_counts);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              free(local_matrix_1);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                free(local_matrix_2); //local_matrix_2 is the same as matrix_2
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  free(matrix_result_part);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    //end MPI
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      MPI_Finalize();

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        return 0;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        /**
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * @brief   Prints a matrix.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          * @param   The matrix
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * @param   n, which is the size of the matrix (n X n)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            * @return  Nothing
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             */
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             void printMatrix(int * matrix, int n) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               int row, col;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 for (row = 0; row < n; row++) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     for (col = 0; col < n; col++) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           if (col != 0)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   printf(" ");

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         printf("%d", matrix[row*n + col]);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 printf("\n");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   /**
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * @brief   Multiplies 2 matrices and returns the resulting
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     *    partial matrix (only goes through num_rows rows of matrix_1).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * @param   A part of the first matrix to multiply
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       *    (has only num_rows of rows)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        * @param   The second matrix to multiply
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * @param   n, which is the size of the matrices (n X n)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          * @param   num_rows, how many rows of matrix_1 to operate on
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * @return  The resulting partial matrix (num_rows X n).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            */
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            int * multiplyMatrix_ijk(int * matrix_1, int * matrix_2,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                int n, int num_rows) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  int * matrix_result = malloc(sizeof(int) * num_rows * n);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    int row, col, k;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      //start doing the matrix multiplication
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        for (row = 0; row < num_rows; row++) { //i
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            for (col = 0; col < n; col++) { //j
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  int c_ij = 0;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        for (k = 0; k < n; k++) { //k
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                c_ij += matrix_1[row*n + k] * matrix_2[k*n + col];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            matrix_result[row*n + col] = c_ij;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return matrix_result;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    /**
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     * @brief   Multiplies 2 matrices and returns the resulting
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      *    partial matrix (only goes through num_rows rows of matrix_1).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * @param   A part of the first matrix to multiply
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        *    (has only num_rows of rows)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * @param   The second matrix to multiply
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          * @param   n, which is the size of the matrices (n X n)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * @param   num_rows, how many rows of matrix_1 to operate on
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            * @return  The resulting partial matrix (num_rows X n).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             */
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             int * multiplyMatrix_ikj(int * matrix_1, int * matrix_2,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 int n, int num_rows) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   int * matrix_result = calloc(num_rows * n, sizeof(int));
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     int row, col, k;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       //start doing the matrix multiplication
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         for (row = 0; row < num_rows; row++) { //i
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             for (k = 0; k < n; k++) { //k
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   int a_ik = matrix_1[row*n + k];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         for (col = 0; col < n; col++) { //j
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 matrix_result[row*n + col] += a_ik * matrix_2[k*n + col];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               return matrix_result;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               /**
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * @brief   Multiplies 2 matrices and returns the resulting
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 *    partial matrix (only goes through num_rows rows of matrix_1).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  * @param   A part of the first matrix to multiply
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   *    (has only num_rows of rows)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * @param   The second matrix to multiply
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     * @param   n, which is the size of the matrices (n X n)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * @param   num_rows, how many rows of matrix_1 to operate on
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * @return  The resulting partial matrix (num_rows X n).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        */
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        int * multiplyMatrix_kij(int * matrix_1, int * matrix_2,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            int n, int num_rows) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              int * matrix_result = calloc(num_rows * n, sizeof(int));
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                int row, col, k;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  //start doing the matrix multiplication
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    for (k = 0; k < n; k++) { //k
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        for (row = 0; row < num_rows; row++) { //i
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              int a_ik = matrix_1[row*n + k];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    for (col = 0; col < n; col++) { //j
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            matrix_result[row*n + col] += a_ik * matrix_2[k*n + col];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          return matrix_result;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          /**
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * @brief   Multiplies 2 matrices and returns the resulting
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            *    partial matrix (only goes through num_rows rows of matrix_1).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             * @param   A part of the first matrix to multiply
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              *    (has only num_rows of rows)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               * @param   The second matrix to multiply, transposed
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * @param   n, which is the size of the matrices (n X n)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 * @param   num_rows, how many rows of matrix_1 to operate on
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  * @return  The resulting partial matrix (num_rows X n).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   */
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   int * multiplyMatrix_ijk_with_trans(int * matrix_1, int * matrix_2,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       int n, int num_rows) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         int * matrix_result = malloc(sizeof(int) * num_rows * n);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           int row, col, k;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             //start doing the matrix multiplication
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               for (row = 0; row < num_rows; row++) { //i
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   for (col = 0; col < n; col++) { //j
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         int c_ij = 0;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               for (k = 0; k < n; k++) { //k
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       c_ij += matrix_1[row*n + k] * matrix_2[k + col*n];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   matrix_result[row*n + col] = c_ij;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           return matrix_result;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           /**
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            * @brief   Multiplies 2 matrices and returns the resulting
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             *    partial matrix (only goes through num_rows rows of matrix_1).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              * @param   A part of the first matrix to multiply
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               *    (has only num_rows of rows)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * @param   The second matrix to multiply, transposed
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 * @param   n, which is the size of the matrices (n X n)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  * @param   num_rows, how many rows of matrix_1 to operate on
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * @return  The resulting partial matrix (num_rows X n).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    */
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    int * multiplyMatrix_ikj_with_trans(int * matrix_1, int * matrix_2,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        int n, int num_rows) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          int * matrix_result = calloc(num_rows * n, sizeof(int));
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            int row, col, k;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              //start doing the matrix multiplication
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                for (row = 0; row < num_rows; row++) { //i
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    for (k = 0; k < n; k++) { //k
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          int a_ik = matrix_1[row*n + k];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                for (col = 0; col < n; col++) { //j
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        matrix_result[row*n + col] += a_ik * matrix_2[k + col*n];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      return matrix_result;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      /**
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * @brief   Multiplies 2 matrices and returns the resulting
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        *    partial matrix (only goes through num_rows rows of matrix_1).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * @param   A part of the first matrix to multiply
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          *    (has only num_rows of rows)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * @param   The second matrix to multiply, transposed
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            * @param   n, which is the size of the matrices (n X n)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             * @param   num_rows, how many rows of matrix_1 to operate on
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              * @return  The resulting partial matrix (num_rows X n).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               */
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               int * multiplyMatrix_kij_with_trans(int * matrix_1, int * matrix_2,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   int n, int num_rows) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     int * matrix_result = calloc(num_rows * n, sizeof(int));
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       int row, col, k;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         //start doing the matrix multiplication
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           for (k = 0; k < n; k++) { //k
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               for (row = 0; row < num_rows; row++) { //i
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     int a_ik = matrix_1[row*n + k];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           for (col = 0; col < n; col++) { //j
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   matrix_result[row*n + col] += a_ik * matrix_2[k + col*n];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 return matrix_result;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 /**
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  * @brief   Transposes a square matrix (in place)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * @param   matrix, the square matrix to transpose
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * @param   n, which is the size of the matrix (n X n)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     * @return  Nothing
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      */
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      void transpose(int * matrix, int n) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        int tmp = 0, i, k;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          for (i = 0; i <= n - 2; i++) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              for (k = i + 1; k <= n - 1; k++) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    //swap matrix[i][k] with matrix[k][i]:

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          tmp = matrix[i*n + k];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                matrix[i*n + k] = matrix[k*n + i];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      matrix[k*n + i] = tmp;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }

